<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" rel="external nofollow" href="/static/img/favicon.ico" />
    <link rel="stylesheet" href="/static/lib/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/static/lib/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/index1.css">
    <script src="/static/lib/jquery/2.1.4/jquery.min.js"></script>
    <script src="/static/lib/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="/static/lib/layui-v2.7.6/layui/css/layui.css" rel="stylesheet">
    <script src="/static/lib/layui-v2.7.6/layui/layui.js"></script>
    <title>首页</title>
    <style>
        h3 {
            text-align: center;
        }

        table {
            table-layout: fixed;
        }

        thead tr th {
            position: sticky;
            background-color: #fff;
            top: 0;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-default navbar-fixed-top" onselectstart="return false">
        <!--onselectstrat 禁止选中-->
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#my-nav"
                    aria-expanded="false">
                    <span class="sr-only">切换导航条</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <!-- <a class="navbar-brand" style="cursor:default;"> -->
                <img src="/static/img/logo_ess.png" alt="ESS" draggable="false">
                <!-- </a> -->
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="my-nav">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/index" style="color: #fff; background-color: rgb(68, 147, 199);">首页</a>
                    </li>
                    <li class="active"><a href="/efficiency">标注效率</a></li>
                    <li class="active"><a href="/performance">个人绩效</a></li>
                    <li class="active" onclick="navswitch('waibao')"><a>外包数据</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li style="border-right: 1px solid #bdbdbd; margin-right: 20px; cursor: pointer;"><a
                            onclick="help()">
                            <i class="fa fa-hand-o-right" style="margin-right: 5px; font-size: 18px;"></i>
                            <span style="font-size: 18px;">Help</span></a>
                    </li>
                    <li role="presentation" class="dropdown" style="width: 139px;">
                        <a class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                            style="text-align: center;">
                            <i class="fa fa-user" style="margin-left: -30px; font-size: 18px;"></i>
                            <span style="font-size: 18px; margin-left: 5px;" id="name"></span><span class="caret"
                                style="margin-left: 10px;"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li style="border-bottom: 1px solid gray;"><a href="/sites/" target="black"><i
                                        class="fa fa-gear"></i><span style="margin-left: 10px;">设置</span></a></li>
                            <li style="border-bottom: 1px solid gray;"><a href="#" onclick="pwd_upd()"><i
                                        class="fa fa-compass"></i><span style="margin-left: 10px;">修改密码</span></a></li>
                            <li onclick="logout()"><a><i class="fa fa-sign-out"></i><span
                                        style="margin-left: 10px;">注销</span></a></li>
                        </ul>
                    </li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>
    <div id="body-div">
        <div id="left">
            <label onclick="add_data_show()">
                <i class="fa fa-plus-square" aria-hidden="true"></i>
                <span>添加数据</span>
            </label>
            <label onclick="search_show()">
                <i class="fa fa-search" aria-hidden="true"></i>
                <span>搜索数据</span>
            </label>
            <label onclick="showData('gsdata_count')">
                <i class="fa fa-bar-chart" aria-hidden="true"></i>
                <span>图表展示</span>
            </label>
            <p>© weilong 2021.12.18</p>
        </div>
        <div id="right">
            <div id="toolbar" style="border-bottom: 1px solid gray; height: 100px;">
                <div class="alert alert-danger hide"
                    style="width: 300px; position: fixed; top: 40%;left: 50%; right: 50%;z-index: 1; font-size: 22px;">
                </div> <!-- 警告弹出框 -->
                <div id="right_daymes">
                    <marquee direction="left" scrollamount="15" id="h3" style="font-size: 24px; line-height: 100px;">
                        {{ every_day_mes }}
                    </marquee>
                </div>
                <div id="right_insert" style="display: none;">
                    <table class="table">
                        <tr>
                            <th>用户名</th>
                            <th>项目名字</th>
                            <th>标注方</th>
                            <th>任务ID</th>
                            <th>日期</th>
                            <th>任务类型</th>
                            <th>图片/视频数量</th>
                            <th>框数/属性/时长</th>
                            <th>工时</th>
                            <th>按钮</th>
                        </tr>
                        <tr>
                            <td><input type="text" name="uname" class="form-control zh_uname" readonly="readonly"
                                    id="uname_insert"></td>
                            <td><select class="form-control" name="pname" id="pname_insert"> </select></td>
                            <td><select class="form-control" name="waibao" id="waibao_insert"></select> </td>
                            <td><input type="number" name="task_id" min="0" class="form-control" id="task_id_insert">
                            </td>
                            <td><input type="date" name="dtime" class="form-control" id="riqi_insert"></td>
                            <td><select class="form-control" name="kinds" id="kinds_insert"></select></td>
                            <td><input type="number" name="pnums" min="0" class="form-control" id="pnums_insert"></td>
                            <td><input type="text" name="knums" min="0" class="form-control" placeholder="123/00:00:00"
                                    id="knums_insert"></td>
                            <td><input type="text" name="ptimes" class="form-control" required='required'
                                    id="ptimes_insert"></td>
                            <td><input type="button" class="btn btn-primary" value="添加" id="btn_insert"></td>
                        </tr>
                    </table>
                </div>
                <div id="right_search" style="display: none;">
                    <table class="table">
                        <tr>
                            <th>用户名</th>
                            <th>项目名字</th>
                            <th>标注方</th>
                            <th>任务ID</th>
                            <th>任务类型</th>
                            <th>开始时间</th>
                            <th>结束时间</th>
                            <th style="text-align: center;">按钮</th>
                        </tr>
                        <tr>
                            <td>
                                <select class="form-control" name="uname" id="uname_search">
                                    <option value="---">---</option>
                                </select>
                            <td>
                                <select class="form-control" name="pname" id="pname_search">
                                    <option value="---">---</option>
                                </select>
                            </td>
                            <td>
                                <select class="form-control" name="bzf" id="bzf_search">
                                    <option value="---">---</option>
                                </select>
                            </td>
                            <td><input type="number" class="form-control" min="0" name="taskid" id="taskid_search"></td>
                            <td>
                                <select class="form-control" name="taskkind" id="taskkind_search">
                                    <option value="---">---</option>
                                </select>
                            </td>
                            <td><input type="date" name="dtime" class="form-control" id="begin_time_search"></td>
                            <td><input type="date" name="lasttime" class="form-control" id="last_time_search"></td>
                            <td>
                                <input type="reset" class="btn btn-default pull-left" id="reset" value="重置">
                                <input type="button" class="btn btn-primary pull-right" id="serch" value="查询">
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <!--工具栏(每行)-->
            <script type="text/html" id="barDemo">
                <a class="layui-btn layui-btn-xs" lay-event="edit"><i class="fa fa-pencil"></i> 编辑</a>
                <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="fa fa-remove"></i> 删除</a>
            </script>
            <table class="layui-hide" id="test" lay-filter="test"></table>
            <!-- 弹窗之密码修改 -->
            <div class="modal fade" tabindex="-1" role="dialog" id="pwd_update">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                            <h3 class="modal-title">修改密码</h3>
                        </div>
                        <div class="modal-body">
                            <form class='form-register' action="/pwd_update/" method="post">
                                {% csrf_token %}
                                <div class="alert alert-warning" id="err_msg" style="display: none;"></div>
                                <div class="form-group">
                                    <label for="recipient-name" class="control-label">用户名:</label>
                                    <input type="text" class="form-control zh_uname" name="uname" readonly="readonly">
                                </div>
                                <div class="form-group">
                                    <label for="recipient-name" class="control-label">请输入新密码:</label>
                                    <input type="password" class="form-control" name="new_pwd1" required>
                                </div>
                                <div class="form-group">
                                    <label for="message-text" class="control-label">再次输入新密码:</label>
                                    <input type="password" class="form-control" name="new_pwd2" required>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                    <button type="submit" class="btn btn-primary">确认</button>
                                </div>
                            </form>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->
        </div><!-- /.modal -->
    </div>

</body>
<script src="/static/js/index.js"></script>
<script src="/static/js/disable.js"></script>
<script>
    const unames = JSON.parse('{{ unames|safe }}')   // 用户列表
    const projects = JSON.parse('{{ projects|safe }}'); // 项目名字
    const tkinds = JSON.parse('{{ tkinds|safe }}'); // 任务类型 列表
    const bzf = JSON.parse('{{ bzf|safe }}'); // 数据标注方

    const table = layui.table;
    //渲染表格
    table.render({//渲染table
        url: '/gsalldata',     //数据获取url
        method: 'GET',         //数据传输方式为post
        elem: '#test',         //设置容器
        // toolbar: 'default',
        height: 'full-185',    //高度为屏幕高度-20
        page: true,
        request: {
            pageName: 'pageIndex',  // 页码的参数名称，默认：page
            limitName: 'pageSize'   // 每页数据量的参数名，默认：limit
        },
        response: {
            statusName: 'code',     // 规定数据状态的字段名称，默认：code
            statusCode: 0,          // 规定成功的状态码，默认：0
            msgName: 'msg',         // 规定状态信息的字段名称，默认：msg
            countName: 'count', // 规定数据总数的字段名称，默认：count
            dataName: 'data'        // 规定数据列表的字段名称，默认：data
        },
        page: {
            layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'],     // 自定义分页布局
            curr: 1,      // 设置默认起始页1
            groups: 5,   //只显示10个连续页码,就是说显示10个可见页其他的省略
            first: '首页', // 不显示首页
            last: '尾页'   // 不显示尾页
        },
        limit: 20,
        limits: [20, 50, 100],
        skin: 'row', //表格风格
        even: true,    //隔行换色
        cols: [[               //设置列标签、标题、宽度、是否排序等
            // {checkbox:true}, // 复选框
            { field: 'id', title: 'ID', fixed: left },
            { field: 'uname', title: '用户名', width: 100 },
            { field: 'pname', title: '项目名字', },
            { field: 'waibao', title: '标注方', },
            { field: 'task_id', title: '任务ID', },
            { field: 'dtime', title: '日期' },
            { field: 'kinds', title: '任务类型', },
            { field: 'pnums', title: '图片/视频数量', },
            { field: 'knums', title: '框数/属性/时长', },
            { field: 'ptimes', title: '工时' },
            { fixed: 'right', title: '操作', toolbar: '#barDemo' },//设置每行的工具栏以及其容器
        ]],
    });
    // 表格后台过滤
    $('#serch').click(function () {
        const uname = $('#uname_search').val();
        const pname = $('#pname_search option:selected').val();
        const bzf = $('#bzf_search option:selected').val();
        const taskid = $("#taskid_search").val();
        const taskkind = $('#taskkind_search option:selected').val();
        const begin_time = $("#begin_time_search").val();
        const last_time = $("#last_time_search").val();
        let url = '/gsalldata?uname=' + uname + '&pname=' + pname + "&bzf=" + bzf + "&taskid=" + taskid + "&taskkind=" + taskkind + "&begin_time=" + begin_time + "&last_time=" + last_time; //第一种方法
        table.reload('test', {
            url: url,
            page: {
                curr: 1 //重新从第 1 页开始
            }
        });
    });
    // 表格过滤重置
    $("#reset").click(function () {
        let url = '/gsalldata'
        table.reload('test', {
            url: url,
            page: {
                curr: 1 //重新从第 1 页开始
            }
        });
        $('#uname_search').find('option:first').prop("selected", "selected");
        $('#pname_search').find('option:first').prop("selected", "selected");
        $('#bzf_search').find('option:first').prop("selected", "selected");
        $("#taskid_search").val("");
        $('#taskkind_search').find('option:first').prop("selected", "selected");
        $("#begin_time_search").val("");
        $("#last_time_search").val("");
    })
    // 操作栏-编辑/删除
    table.on('tool(test)', function (obj) { // 双击 toolDouble
        var data = obj.data;
        console.log(obj.data)
        if (obj.event === 'del') {
            if (sessionStorage.getItem("power") != '1') {
                $(".alert-danger").html("您没有删除数据的权限，请联系管理员!");
                $(".alert-danger").addClass("show");
                window.setTimeout(function () {
                    $(".alert-danger").removeClass("show");
                }, 1000);//显示的时间
            } else {
                layer.confirm('真的删除行么', function (index) {
                    $.ajax("/dtdel/", {
                        method: "GET",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: {
                            n: $("#name").text(),
                            id: obj.data.id
                        },
                    }).done(function (res) {
                        if (res && res.data == "successful") {
                            console.log('删除成功');

                            let url = '/gsalldata'
                            table.reload('test', { url: url, page: { curr: 1 } });//重新从第 1 页开始

                            $(".alert-danger").html("ID: " + obj.data.id + " 删除成功!");
                            $(".alert-danger").addClass("show");
                            window.setTimeout(function () {
                                $(".alert-danger").removeClass("show");
                            }, 1000);//显示的时间
                        } else {
                            console.log('删除失败!');
                        }
                    });

                    layer.close(index);
                });
            }
        } else if (obj.event === 'edit') {// 数据修改
            if (obj.data.uname != $('#name').text()) {
                $(".alert-danger").html("您只能修改自己的数据喔!");
                $(".alert-danger").addClass("show");
                window.setTimeout(function () {
                    $(".alert-danger").removeClass("show");
                }, 1000);//显示的时间
            } else {
                document.location.href = "/update?id=" + obj.data.id;
            };
        }
    });

    // 每日一言 每刷新切换颜色
    function color_random() {
        var color = "#";
        var randomArr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f'];//这是颜色构成的所有情况
        for (var i = 0; i < 6; i++) {
            color += randomArr[parseInt(Math.random() * 15)];
        }
        return color;
    };
    document.getElementById("h3").style.color = color_random();

    // 添加数据
    function add_data_show() {
        if ($('#right_daymes').css('display') == 'block' || $('#right_search').css('display') == 'block') {
            $('#right_insert').css("display", "block");
            $('#right_daymes').css("display", "none");
            $('#right_search').css("display", "none");
        } else {
            $('#right_insert').css("display", "none");
            $('#right_daymes').css("display", "block");
        }
        // 给用户名赋值
        $(".zh_uname").val($("#name").text());
        // 添加数据之 日期组件默认为当天日期
        var mydateInput = document.getElementById("riqi_insert");
        var now = new Date();
        var day = ('0' + now.getDate()).slice(-2);
        var month = ('0' + (now.getMonth() + 1)).slice(-2);
        var today = now.getFullYear() + '-' + (month) + '-' + (day);
        mydateInput.value = today;

        // 给数据标注方 赋值
        var bzfs = document.getElementById('waibao_insert');
        for (var i = 0; i < bzf.length; i++) {
            if (bzfs.length < bzf.length) { // 这里不判断的话会一直添加
                if (bzf[i] != document.getElementById("waibao_insert").value) {
                    var objOption = document.createElement("option");
                    objOption.value = bzf[i];
                    objOption.text = bzf[i];
                    bzfs.add(objOption);
                };
            };
        };
        // 给项目名字 添加下拉框
        var p_s = document.getElementById('pname_insert');
        for (var i = 0; i < projects.length; i++) {
            if (p_s.length < projects.length) { // 这里不判断的话会一直添加
                if (projects[i] != document.getElementById("pname_insert").value) {
                    var objOption = document.createElement("option");
                    objOption.value = projects[i];
                    objOption.text = projects[i];
                    p_s.add(objOption);
                };
            };
        };
        // 给任务类型 赋值
        var tk_s = document.getElementById('kinds_insert');
        for (var i = 0; i < tkinds.length; i++) {
            if (tk_s.length < tkinds.length) { // 这里不判断的话会一直添加
                if (tkinds[i] != document.getElementById("kinds_insert").value) {
                    var objOption = document.createElement("option");
                    objOption.value = tkinds[i];
                    objOption.text = tkinds[i];
                    tk_s.add(objOption);
                };
            };
        };
    }
    // 添加数据--
    $("#btn_insert").click(function () {
        const uname = $("#uname_insert").val();
        const pname = $("#pname_insert option:selected").val();
        const waibao = $("#waibao_insert option:selected").val();
        const task_id = $("#task_id_insert").val();
        const dtime = $("#riqi_insert").val();
        const kinds = $("#kinds_insert option:selected").val();
        const pnums = $("#pnums_insert").val();
        const knums = $("#knums_insert").val();
        const ptimes = $("#ptimes_insert").val();
        $.ajax("/insert/", {
            method: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: {
                uname:uname,
                pname:pname,
                waibao:waibao,
                task_id:task_id,
                dtime:dtime,
                kinds:kinds,
                pnums:pnums,
                knums:knums,
                ptimes:ptimes
            },
        }).done(function (res) {
            if (res && res.data == "successful") {
                $("#task_id_insert").val("");
                $("#pnums_insert").val("");
                $("#knums_insert").val("");
                $("#ptimes_insert").val("");
                
                let url = '/gsalldata'
                table.reload('test', { url: url, page: { curr: 1 } });//重新从第 1 页开始

                $(".alert-danger").html("添加成功!");
                $(".alert-danger").addClass("show");
                window.setTimeout(function () {
                    $(".alert-danger").removeClass("show");
                }, 1000);//显示的时间
            } else {
                $(".alert-danger").html(res.data);
                $(".alert-danger").addClass("show");
                window.setTimeout(function () {
                    $(".alert-danger").removeClass("show");
                }, 1500);//显示的时间
            }
        });
    })
    // 搜索数据
    function search_show() {
        if ($('#right_daymes').css('display') == 'block' || $('#right_insert').css('display') == 'block') {
            $('#right_search').css("display", "block");
            $('#right_daymes').css("display", "none");
            $('#right_insert').css("display", "none");
        } else {
            $('#right_search').css("display", "none");
            $('#right_daymes').css("display", "block");
        }
        // 给用户 添加下拉框
        var u_n = document.getElementById('uname_search');
        for (var i = 0; i < unames.length; i++) {
            if (u_n.length < unames.length + 1) { // 这里不判断的话会一直添加
                if (unames[i] != document.getElementById("uname_search").value) {
                    var objOption = document.createElement("option");
                    objOption.value = unames[i];
                    objOption.text = unames[i];
                    u_n.add(objOption);
                };
            };
        };
        // 给项目名字 添加下拉框
        var p_s = document.getElementById('pname_search');
        for (var i = 0; i < projects.length; i++) {
            if (p_s.length < projects.length + 1) { // 这里不判断的话会一直添加
                if (projects[i] != document.getElementById("pname_search").value) {
                    var objOption = document.createElement("option");
                    objOption.value = projects[i];
                    objOption.text = projects[i];
                    p_s.add(objOption);
                };
            };
        };
        // 给标注方 添加下拉框
        var bzf_s = document.getElementById('bzf_search');
        for (var i = 0; i < projects.length; i++) {
            if (bzf_s.length < bzf.length + 1) { // 这里不判断的话会一直添加
                if (bzf[i] != document.getElementById("bzf_search").value) {
                    var objOption = document.createElement("option");
                    objOption.value = bzf[i];
                    objOption.text = bzf[i];
                    bzf_s.add(objOption);
                };
            };
        };
        // 给任务类型 添加下拉框
        var taskkind_s = document.getElementById('taskkind_search');
        for (var i = 0; i < projects.length; i++) {
            if (taskkind_s.length < tkinds.length + 1) { // 这里不判断的话会一直添加
                if (tkinds[i] != document.getElementById("taskkind_search").value) {
                    var objOption = document.createElement("option");
                    objOption.value = tkinds[i];
                    objOption.text = tkinds[i];
                    taskkind_s.add(objOption);
                };
            };
        };
    }

    function help() {
        alert('请联系卫龙');
    };

    function pwd_upd() {
        $('#pwd_update').modal('show');
        $(".zh_uname").val($("#name").text());
    };

    function logout() {
        sessionStorage.setItem("isLogin", "");
        sessionStorage.setItem("zhuname", "");
        sessionStorage.setItem("power", "");
        window.location.href = '/login'
    }

    // 更细密码
    function update_pwd() {
        const new_pwd1 = $(".new_pwd1").val();
        const new_pwd2 = $(".new_pwd2").val();

        if (new_pwd1 != new_pwd2) return false;
        else return true;
    }

    // 数据修改
    function test(id, uname) {
        if (uname != $('#name').text()) {
            alert('无权限修改');
        } else {
            document.location.href = "/update?id=" + id;
        };
    };

    // 整合
    function showData(flag) {
        if (flag == 'gsdata_count') {
            window.location.href = '/gsdata_count'
        }
    }

    // 页数跳转
    function page_switch() {
        var total_id = parseInt($('#total_page').text()); // 总页数
        var input_id = parseInt($('#now_page').val()); // 输入的页数
        if (input_id <= 0 | input_id > total_id) {
            alert('请输入正确的页数!');
        } else {
            window.location.href = '/index?page_id=' + input_id;
        };
    };

    // 导航栏
    function navswitch(flag) {
        if (sessionStorage.getItem("power") == '2') {
            alert("您没有权限查看!");
        } else {
            window.location.href = '/' + flag;
        }
    }
</script>

</html>