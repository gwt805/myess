{% extends 'login/base.html' %}
{% block title %}主页{% endblock %}
{% block css %}
    <style>
        h3 {text-align: center;}
        button:hover{color: blue;}
        table {table-layout: fixed;}
        thead tr th {
            position:sticky;
            background-color: #bdbdbd;
            top:0;
        }
    </style>
{% endblock %}
{% block navbar %}
    <ul class="nav navbar-nav">
        {% if request.session.user_power == 1 %}
            <li class="active"><a href="/index?name={{ request.session.zh_uname }}">首页</a></li>
            <li class="active"><a href="/efficiency">效率查看</a></li>
            <li class="active"><a href="/performance">绩效</a></li>
            <li class="active"><a href="/waibao">外包数据</a></li>
            <!-- 批量添加 -->
            <div id="div-execl" style="float: right; position: relative; margin-top: 10px; margin-left: 400px;">
                <form action="/insert/" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <table>
                        <tr>
                            <td><input type="file" name="file_obj" style="margin-right: -75px;"></td>
                            <td><input type="submit" value="批量添加"></td>
                            <td><span style="color: red">{{ error }}</span></td>
                            <td><a href="/static/files/gs_insert_template.xlsx" download="gs_insert_template.xlsx" style="margin-left: 20px;">点击下载GS数据批量添加模板</a></td>
                        </tr>
                    </table>
                </form>
            </div>
        {% elif request.session.user_power == 2 %}
            <li class="active"><a href="/index?name={{ request.session.user_name }}">首页</a></li>
            <li class="active"><a href="/efficiency">效率查看</a></li>
            <li class="active"><a href="/performance">绩效</a></li>
            <!-- 批量添加 -->
            <div id="div-execl" style="float: right; margin-top: 10px; margin-left: 400px;">
                <form action="/insert/" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <table>
                        <tr>
                            <td><input type="file" name="file_obj" style="margin-right: -75px;"></td>
                            <td><input type="submit" value="批量添加"></td>
                            <td><span style="color: red">{{ error }}</span></td>
                            <td><a href="/static/files/gs_insert_template.xlsx" download="gs_insert_template.xlsx" style="margin-left: 20px;">点击下载GS数据批量添加模板</a></td>
                        </tr>
                    </table>
                </form>
            </div>
        {% elif request.session.user_power == 3 %}
            <li class="active"><a href="/waibao">外包数据</a></li>
        {% elif request.session.user_power == 4 %}
        {% endif %}
        
    </ul>
{% endblock %}

{% block content %}
    {% if request.session.user_power == 1 or request.session.user_power == 2 %}
        <div style="min-width:7%; height: 100%; position: fixed; float: left; margin-top: -20px; background-color: #a3a3a3;" onselectstart="return false"> <!-- 侧边栏div-->
            <div> <!-- 操作栏 -->
                <ul class="nav nav-pills nav-stacked">
                    <li role="presentation" style="cursor: pointer;"><a onclick="ginsert()" style="color: black;">添加数据</a></li>
                    <li role="presentation" style="cursor: pointer;"><a onclick="showp(window)" style="color: black;">展示个人当天数据</a></li>
                    <li role="presentation" style="cursor: pointer;"><a onclick="showpall(window)" style="color: black;">展示个人所有数据</a></li>
                    <li role="presentation" style="cursor: pointer;"><a onclick="showpd(window)" style="color: black;">展示所有人当天数据</a></li>
                    <li role="presentation" style="cursor: pointer;"><a onclick="showa(window)" style="color: black;">展示所有数据</a></li>
                    <li role="presentation" style="cursor: pointer;" onclick="search()"><a style="color: black;">搜索</a></li>
                    <li role="presentation" style="cursor: pointer;"><a href="/gsdata_count/" style="color: black;">图表展示</a></li>
                    {% if request.session.user_power == 1 %}<!-- 只有管理员才能删除数据 -->
                        <li role="presentation" style="cursor: pointer;"><a onclick="pl_dl(window)" style="color: black;">批量删除</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <div style="float: left; height: 100%; width: 91.8%; margin-top: -20px; position: fixed; margin-left: 157px; background-color: #bdbdbd;"> <!-- 右边主体div-->
            <div style="width: 100%; height: 10%;"> <!-- 右边上面div -->
                <div id="index_right_img" style="overflow: hidden; width: 1877px; height: 90px;border-bottom: 1px solid white;">
                    <h3 style="line-height: 60px;">{{ every_day_say_api }}</h3>
                </div>
                <!-- insert -->
                <div id="ginsert" style="display: none;">
                    <form class='form-register' action="/insert/" method="post">
                        {% if message %}
                        <div class="alert alert-warning" id="warning">{{ message }}</div>
                        {% endif %}
                            {% csrf_token %}
                        <table class="table">
                            <tr>
                                <th>用户名</th>
                                <th>项目名字</th>
                                <th>标注方</th>
                                <th>任务ID</th>
                                <th>日期</th>
                                <th>任务类型</th>
                                <th>图片/视频数量</th>
                                <th>框数/属性/时长</th>
                                <th>工时</th>
                                <th>按钮</th>
                            </tr>
                            <tr>
                                <td><input type="text" name="uname" value="{{ request.session.zh_uname }}" class="form-control" readonly="readonly"></td>
                                <td><select class="form-control" name="pname" id="pname"> </select></td>
                                <td><select class="form-control" name="waibao" id="waibao"></select> </td>
                                <td><input type="number" name="task_id" class="form-control"></td>
                                <td><input type="date" name="dtime" class="form-control" id="riqi"></td>
                                <td><select class="form-control" name="kinds" id="kinds"></select></td>
                                <td><input type="number" name="pnums" class="form-control"></td>
                                <td><input type="text" name="knums" class="form-control" placeholder="123/00:00:00"></td>
                                <td><input type="text" name="ptimes" class="form-control" required='required'></td>
                                <td><input type="submit" class="btn btn-primary" value="添加"></td>
                            </tr>
                        </table>
                    </form>
                </div>
                <!-- searcch -->
                <div id="search" style="display: none;">
                    <form class='form-register' action="/index/" method="post">
                        {% csrf_token %}
                        <table class="table">
                            <tr>
                                <th>用户名</th>
                                <th>项目名字</th>
                                <th>标注方</th>
                                <th>任务ID</th>
                                <th>任务类型</th>
                                <th>开始时间</th>
                                <th>结束时间</th>
                                <th style="text-align: center;">按钮</th>
                            </tr>
                            <tr>
                                <td><input type="text" class="form-control" name="uname"></td>
                                <td>
                                    <select class="form-control" name="pname" id="spname">
                                        <option value ="---">---</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="form-control" name="bzf" id="bzf">
                                        <option value ="---">---</option>
                                    </select>
                                </td>
                                <td><input type="number" class="form-control" name="taskid"></td>
                                <td>
                                    <select class="form-control" name="taskkind" id="taskkind">
                                        <option value ="---">---</option>
                                    </select>
                                </td>
                                <td><input type="date" name="dtime" class="form-control" id="sriqi"></td>
                                <td><input type="date" name="lasttime" class="form-control" id="lasttime"></td>
                                <td>
                                    <input type="reset" class="btn btn-default pull-left" value="重置">
                                    <input type="submit" class="btn btn-primary pull-right" value="搜索">
                                </td>
                            </tr>
                        </table>
                    </form>
                </div>
            </div> <!-- 右边上面div -->
            <!-- show -->
            <div style="position: fixed; width: 91.7%; height: 83%; overflow-y: auto; background-color: #bdbdbd;"> <!-- 展示div-->
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th><span style="margin-right: 10px;" onclick="qx_all()"><input type="checkbox" name="fbs" id="fbs"> 全选</span>用户名</th>
                            <th>项目名字</th>
                            <th>标注方</th>
                            <th>任务ID</th>
                            <th>日期</th>
                            <th>任务类型</th>
                            <th>图片/视频数量</th>
                            <th>框数/属性/时长</th>
                            <th>工时</th>
                            <th>修改</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tasks in stus %}
                            <tr>
                                <td><span style="margin-right: 45px;"><input type="checkbox" name="fb" value="{{ tasks.id }}"></span>{{ tasks.uname }}</td>
                                <td>{{ tasks.pname }}</td>
                                <td>{{ tasks.waibao }}</td>
                                <td>{{ tasks.task_id }}</td>
                                <td>{{ tasks.dtime }}</td>
                                <td>{{ tasks.kinds }}</td>
                                <td>{{ tasks.pnums }}</td>
                                <td>{{ tasks.knums }}</td>
                                <td>{{ tasks.ptimes }}</td>
                                <td><a onclick='test("{{ tasks.id }}","{{ tasks.uname }}")'><button style="border:none">修改</button></a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="container" style="margin-left: 32.5%;"> <!-- 底部页数 -->
                    {% if stus.has_previous %}
                        <a href="/index?page_id={{stus.previous_page_number}}">
                            <button class="btn btn-default">上一页</button>
                        </a>
                    {% endif %}

                    {% if sum_page %}
                        <span> {{ first_page }} / {{ sum_page }}</span>
                    {% endif %}

                    {% if stus.has_next %}
                        <a href="/index?page_id={{stus.next_page_number}}">
                            <button class="btn btn-default">下一页</button>
                        </a>
                    {% endif %}

                    {% if sum_page %}
                        <span style="margin-left: 10px;">共<span id="total_page">{{ sum_page }}</span>页</span>
                        <span>
                            到第 <input type="text" class="form-control" style="width: 60px; display: inline;" id="now_page"> 页 
                            <button class="btn btn-default" style="margin-left: 10px;" onclick="page_switch()">确定</button>
                        </span>
                    {% endif %}
                </div>

            </div>
        </div>
    {% endif %}
<script type="text/javascript">
    // 数据修改
    function test(id,uname){
        if (uname != $('#id_name').text()){
            alert('无权限修改');
        }else{
            document.location.href = "/update?id="+id;
        };
    };
    //----------------------------添加数据 之 下拉框动态赋值------------------------------
    var projects = JSON.parse('{{ projects|safe }}'); // 项目名字 列表
    var tkinds = JSON.parse('{{ tkinds|safe }}'); // 任务类型 列表
    var bzf = JSON.parse('{{ bzf|safe }}'); // 数据标注方
    // insert
    function ginsert(){
        if ($('#ginsert').css('display') == 'none'){
            $('#ginsert').css("display","block");
            $('#index_right_img').css("display","none");
            // 添加数据之 日期组件默认为当天日期
            var mydateInput = document.getElementById("riqi");
            var now = new Date();
            var day = ('0' + now.getDate()).slice(-2);
            var month = ('0' + (now.getMonth() + 1)).slice(-2);
            var today = now.getFullYear() + '-' + (month)+ '-' + (day);
            mydateInput.value = today;

            // 给数据标注方 赋值
            var bzfs = document.getElementById('waibao');
            for (var i=0;i<bzf.length;i++){
                if (bzfs.length < bzf.length){ // 这里不判断的话会一直添加
                    if (bzf[i] != document.getElementById("waibao").value){
                        var objOption = document.createElement("option");
                        objOption.value = bzf[i];
                        objOption.text =bzf[i];
                        bzfs.add(objOption);
                    };
                };
            };

            // 给项目名字 添加下拉框
            var p_s = document.getElementById('pname');
            for (var i=0;i<projects.length;i++){
                if (p_s.length < projects.length){ // 这里不判断的话会一直添加
                    if (projects[i] != document.getElementById("pname").value){
                        var objOption = document.createElement("option");
                        objOption.value = projects[i];
                        objOption.text =projects[i];
                        p_s.add(objOption);
                    };
                };
            };

            // 给任务类型 赋值
            var tk_s = document.getElementById('kinds');
            for (var i=0;i<tkinds.length;i++){
                if (tk_s.length < tkinds.length){ // 这里不判断的话会一直添加
                    if (tkinds[i] != document.getElementById("kinds").value){
                        var objOption = document.createElement("option");
                        objOption.value = tkinds[i];
                        objOption.text =tkinds[i];
                        tk_s.add(objOption);
                    };
                };
            };
        }else{
            $('#ginsert').css("display","none");
            $('#index_right_img').css("display","block");
        };
        if ($('#search').css('display') == 'block'){
            $('#search').css("display","none");
        };
    };
    
    // 搜索之日期组件默认为当天日期
    function search(){
        if ($('#search').css('display') == 'none'){
            $('#index_right_img').css("display","none");
            $('#search').css("display","block");
            
            var mydateInput = document.getElementById("sriqi");
            var now = new Date();
            var day = ('0' + now.getDate()).slice(-2);
            var month = ('0' + (now.getMonth() + 1)).slice(-2);
            var today = now.getFullYear() + '-' + (month)+ '-' + (day);
            mydateInput.value = today;

            // 给项目名字 添加下拉框
            var p_s = document.getElementById('spname');
            for (var i=0;i<projects.length;i++){
                if (p_s.length < projects.length+1){ // 这里不判断的话会一直添加
                    if (projects[i] != document.getElementById("pname").value){
                        var objOption = document.createElement("option");
                        objOption.value = projects[i];
                        objOption.text =projects[i];
                        p_s.add(objOption);
                    };
                };
            };
            // 给标注方 添加下拉框
            var bzf_s = document.getElementById('bzf');
            for (var i=0;i<projects.length;i++){
                if (bzf_s.length < bzf.length+1){ // 这里不判断的话会一直添加
                    if (bzf[i] != document.getElementById("bzf").value){
                        var objOption = document.createElement("option");
                        objOption.value = bzf[i];
                        objOption.text = bzf[i];
                        bzf_s.add(objOption);
                    };
                };
            };
            // 给任务类型 添加下拉框
            var taskkind_s = document.getElementById('taskkind');
            for (var i=0;i<projects.length;i++){
                if (taskkind_s.length < tkinds.length+1){ // 这里不判断的话会一直添加
                    if (tkinds[i] != document.getElementById("taskkind").value){
                        var objOption = document.createElement("option");
                        objOption.value = tkinds[i];
                        objOption.text = tkinds[i];
                        taskkind_s.add(objOption);
                    };
                };
            };
        }else {
            $('#search').css("display","none");
            $('#index_right_img').css("display","block");
        };
        if ($('#ginsert').css('display') == 'block'){
            $('#ginsert').css("display","none");
        };
    };

    //showp
    function showp(windows){
        windows.location.href="/index?showp=" + $('#id_name').text();
    };
    //showpall
    function showpall(windows){
        windows.location.href="/index?showpall=" + $('#id_name').text();
    };
    //showa
    function showa(windows){
        windows.location.href="/index?showa=all";
    };
    //showpd
    function showpd(windows){
        windows.location.href="/index?showpd=pd";
    };

    // 全选/全不选
    function qx_all(){
        var fall = document.getElementById("fbs");
        var alls = document.getElementsByName("fb");
        if(fall.checked == false){
            for (var i = 0; i < alls.length; i++) {
                alls[i].checked = false;
            };
        }else{
            for (var i = 0; i < alls.length; i++) {
                alls[i].checked = true;
                };
        };
    };

    //批量删除
    function pl_dl(windows){
        var alls = document.getElementsByName("fb");
        var fb_flag = false
        var id_list = '';
        for (var i = 0; i < alls.length; i++){
                if (alls[i].checked){
                    fb_flag = true;
            };
        };
        if (fb_flag == false){
            alert('请选择要删除的数据!');
            windows.location.href;
        }else{
            if (confirm('确定要删除吗?')){ //删除时的确认提示，如果点击取消则不删除
                for (var i = 0; i < alls.length; i++){
                    if (alls[i].checked){
                        if (i+1 == alls.length){
                            id_list = id_list + alls[i].value;
                        }else{
                            id_list = id_list + alls[i].value + ',';
                        };
                    };
                };
                windows.location.href="/dtdel?dtid=" + id_list+'&n='+$('#id_name').text();
            }else{
                windows.location.href;
            };
        };
    };
    
    // 页数跳转
    function page_switch(){
        var total_id= parseInt($('#total_page').text()); // 总页数
        var input_id= parseInt($('#now_page').val()); // 输入的页数
        if (input_id <= 0 | input_id > total_id){
            alert('请输入正确的页数!');
        }else{
            window.location.href = '/index?page_id=' + input_id;
        };
    };
</script>
{% endblock %}
